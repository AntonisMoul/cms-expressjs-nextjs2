// Prisma schema for CMS core models
// Based on Botble CMS database structure

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  firstName String?
  lastName  String?
  username  String?  @unique
  password  String
  avatarId  String?
  superUser Boolean  @default(false)
  lastLogin DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roles     UserRole[]
  meta      UserMeta[]
  auditLogs AuditHistory[]

  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  permissions Json?
  description String?
  isDefault   Boolean  @default(false)
  createdBy   String
  updatedBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users UserRole[]

  @@map("roles")
}

model UserRole {
  id     String @id @default(cuid())
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("role_users")
}

model UserMeta {
  id     String @id @default(cuid())
  key    String
  value  String?
  userId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, key])
  @@map("user_meta")
}

model Setting {
  id    String @id @default(cuid())
  key   String @unique
  value String?

  @@map("settings")
}

model AuditHistory {
  id            String   @id @default(cuid())
  userId        String
  module        String   @index
  action        String
  request       Json?
  userAgent     String?
  ipAddress     String?
  referenceUser String
  referenceId   String
  referenceName String
  type          String
  createdAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("audit_histories")
}

model Slug {
  id         String  @id @default(cuid())
  key        String
  entityId   String
  entityType String
  prefix     String?
  fullPath   String
  locale     String  @default("en")
  isActive   Boolean @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([key, locale])
  @@index([entityType, entityId])
  @@index([key, prefix])
  @@map("slugs")
}

model Language {
  id        String  @id @default(cuid())
  name      String
  locale    String @unique
  code      String
  flag      String?
  isDefault Boolean @default(false)
  order     Int     @default(0)
  isRTL     Boolean @default(false)

  @@map("languages")
}

// Activation tokens for user email verification
model Activation {
  id         String   @id @default(cuid())
  userId     String   @index
  code       String
  completed  Boolean  @default(false)
  completedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("activations")
}

// Password reset tokens
model PasswordResetToken {
  id         String   @id @default(cuid())
  email      String
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  @@map("password_reset_tokens")
}

// Pages (from pages plugin)
model Page {
  id           String   @id @default(cuid())
  name         String
  content      String?
  userId       String?
  image        String?
  template     String?
  isFeatured   Boolean  @default(false)
  description  String?
  status       String   @default("published")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User?    @relation(fields: [userId], references: [id])
  translations PageTranslation[]

  @@map("pages")
}

model PageTranslation {
  langCode String
  pagesId  String
  name     String?
  description String?
  content  String?

  page     Page     @relation(fields: [pagesId], references: [id], onDelete: Cascade)

  @@unique([langCode, pagesId])
  @@map("pages_translations")
}

// Blog Posts (from blog plugin)
model Post {
  id           String   @id @default(cuid())
  name         String
  description  String?
  content      String?
  status       String   @default("published")
  authorId     String?
  authorType   String   @default("User")
  isFeatured   Boolean  @default(false)
  image        String?
  views        Int      @default(0)
  formatType   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  author       User?    @relation(fields: [authorId], references: [id])
  categories   PostCategory[]
  tags         PostTag[]
  translations PostTranslation[]

  @@map("posts")
}

model Category {
  id           String   @id @default(cuid())
  name         String
  parentId     String   @default("0")
  description  String?
  status       String   @default("published")
  authorId     String?
  authorType   String   @default("User")
  icon         String?
  order        Int      @default(0)
  isFeatured   Boolean  @default(false)
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  author       User?    @relation(fields: [authorId], references: [id])
  posts        PostCategory[]
  translations CategoryTranslation[]

  @@map("categories")
}

model Tag {
  id          String   @id @default(cuid())
  name        String
  authorId    String?
  authorType  String   @default("User")
  description String?
  status      String   @default("published")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  author      User?    @relation(fields: [authorId], references: [id])
  posts       PostTag[]
  translations TagTranslation[]

  @@map("tags")
}

model PostCategory {
  postId     String
  categoryId String

  post     Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([postId, categoryId])
  @@map("post_categories")
}

model PostTag {
  postId String
  tagId  String

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@map("post_tags")
}

model PostTranslation {
  langCode    String
  postsId     String
  name        String?
  description String?
  content     String?

  post Post @relation(fields: [postsId], references: [id], onDelete: Cascade)

  @@unique([langCode, postsId])
  @@map("posts_translations")
}

model CategoryTranslation {
  langCode     String
  categoriesId String
  name         String?
  description  String?

  category Category @relation(fields: [categoriesId], references: [id], onDelete: Cascade)

  @@unique([langCode, categoriesId])
  @@map("categories_translations")
}

model TagTranslation {
  langCode String
  tagsId   String
  name     String?
  description String?

  tag Tag @relation(fields: [tagsId], references: [id], onDelete: Cascade)

  @@unique([langCode, tagsId])
  @@map("tags_translations")
}

// Media Manager (from media plugin)
model MediaFolder {
  id     String @id @default(cuid())
  userId String
  name   String?
  slug   String?
  parentId String @default("0")
  color  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  user User @relation(fields: [userId], references: [id])
  files MediaFile[]

  @@map("media_folders")
}

model MediaFile {
  id       String @id @default(cuid())
  userId   String
  name     String
  folderId String @default("0")
  mimeType String
  size     Int
  url      String
  options  Json?
  alt      String?
  visibility String @default("public")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  user   User @relation(fields: [userId], references: [id])
  folder MediaFolder? @relation(fields: [folderId], references: [id])

  @@map("media_files")
}

model MediaSetting {
  id      String @id @default(cuid())
  key     String
  value   String?
  mediaId String?
  userId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("media_settings")
}

// Menu System (from menu plugin)
model Menu {
  id       String @id @default(cuid())
  name     String
  slug     String? @unique
  status   String @default("published")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  nodes     MenuNode[]
  locations MenuLocation[]

  @@map("menus")
}

model MenuNode {
  id           String @id @default(cuid())
  menuId       String
  parentId     String @default("0")
  referenceId  String?
  referenceType String?
  url          String?
  iconFont     String?
  position     Int @default(0)
  title        String?
  cssClass     String?
  target       String @default("_self")
  hasChild     Boolean @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  menu Menu @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@map("menu_nodes")
}

model MenuLocation {
  id     String @id @default(cuid())
  menuId String
  location String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  menu Menu @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([location])
  @@map("menu_locations")
}

// Menu System (from menu plugin)
model Menu {
  id     String @id @default(cuid())
  name   String
  slug   String? @unique
  status String @default("published")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  nodes    MenuNode[]
  locations MenuLocation[]

  @@map("menus")
}

model MenuNode {
  id             String @id @default(cuid())
  menuId         String
  parentId       String @default("0")
  referenceId    String?
  referenceType  String?
  url            String?
  iconFont       String?
  position       Int @default(0)
  title          String?
  cssClass       String?
  target         String @default("_self")
  hasChild       Boolean @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  menu Menu @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@index([menuId, parentId])
  @@map("menu_nodes")
}

model MenuLocation {
  id     String @id @default(cuid())
  menuId String
  location String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  menu Menu @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([location])
  @@map("menu_locations")
}

// Widget System (from widget plugin)
model Widget {
  id       String @id @default(cuid())
  widgetId String
  sidebarId String
  theme    String
  position Int @default(0)
  data     Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("widgets")
}
