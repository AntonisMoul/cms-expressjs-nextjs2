// Prisma schema for Botble CMS reimplementation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Authentication & Users
model User {
  id            Int      @id @default(autoincrement())
  firstName     String?  @db.VarChar(120)
  lastName      String?  @db.VarChar(120)
  username      String?  @unique @db.VarChar(60)
  email         String   @unique @db.VarChar(255)
  password      String?  @db.VarChar(120)
  avatarId      Int?
  superUser     Boolean  @default(false)
  manageSupers  Boolean  @default(false)
  permissions   String?  @db.Text
  lastLogin     DateTime?
  sessionsInvalidatedAt DateTime?
  phone         String?  @db.VarChar(20)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  activations Activation[]
  userMeta     UserMeta[]
  roles        UserRole[]
  auditLogs    AuditHistory[]
  createdRoles Role[]     @relation("RoleCreatedBy")
  updatedRoles Role[]     @relation("RoleUpdatedBy")

  @@map("users")
}

model Activation {
  id         Int      @id @default(autoincrement())
  userId     Int      @unique
  code       String   @db.VarChar(120)
  completed  Boolean  @default(false)
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("activations")
}

// RBAC System
model Role {
  id          Int      @id @default(autoincrement())
  slug        String   @unique @db.VarChar(120)
  name        String   @db.VarChar(120)
  permissions String?  @db.Text
  description String?  @db.VarChar(400)
  isDefault   Boolean  @default(false) @db.TinyInt
  createdBy   Int
  updatedBy   Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users       UserRole[]
  creator     User      @relation("RoleCreatedBy", fields: [createdBy], references: [id])
  updater     User      @relation("RoleUpdatedBy", fields: [updatedBy], references: [id])

  @@map("roles")
}

model UserRole {
  id     Int @id @default(autoincrement())
  userId Int
  roleId Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("role_users")
}

// Settings Store
model Setting {
  id    Int     @id @default(autoincrement())
  key   String  @unique @db.VarChar(255)
  value String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

// Audit Logging
model AuditHistory {
  id           Int     @id @default(autoincrement())
  userId       Int
  module       String  @db.VarChar(60)
  request      String? @db.Text
  action       String  @db.VarChar(120)
  userAgent    String? @db.Text
  ipAddress    String? @db.VarChar(45)
  referenceUser Int
  referenceId   Int
  referenceName String @db.VarChar(255)
  type         String  @db.VarChar(20)
  actorType    String? @db.VarChar(255)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([module])
  @@index([action])
  @@map("audit_histories")
}

// Slug/Permalink System
model Slug {
  id            Int     @id @default(autoincrement())
  key           String
  referenceId   Int
  referenceType String
  prefix        String?
  isActive      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([key, referenceType, prefix])
  @@index([referenceId])
  @@index([referenceType])
  @@index([key])
  @@index([prefix])
  @@index([key, prefix])
  @@map("slugs")
}

// Locale System
model Language {
  id        Int     @id @default(autoincrement())
  code      String  @unique @db.VarChar(20)
  name      String  @db.VarChar(120)
  flag      String? @db.VarChar(20)
  isDefault Boolean @default(false) @db.TinyInt
  isActive  Boolean @default(true) @db.TinyInt
  order     Int     @default(0)
  isRtl     Boolean @default(false) @db.TinyInt

  @@map("languages")
}

// User Meta (for preferences and additional data)
model UserMeta {
  id     Int     @id @default(autoincrement())
  key    String  @db.VarChar(120)
  value  String? @db.Text
  userId Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([key, userId])
  @@index([userId])
  @@map("user_meta")
}

